(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d2226eb"],{cf1c:function(s,t,a){"use strict";a.r(t);var n=function(){var s=this,t=s.$createElement;s._self._c;return s._m(0)},e=[function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"content"},[a("h3",{attrs:{id:"axios-%E6%8B%A6%E6%88%AA%E9%87%8D%E5%A4%8D%E8%AF%B7%E6%B1%82"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#axios-%E6%8B%A6%E6%88%AA%E9%87%8D%E5%A4%8D%E8%AF%B7%E6%B1%82"}}),s._v(" axios 拦截重复请求")]),a("h4",{attrs:{id:"%E4%B8%80%E7%9B%B4%E8%A2%AB%E8%BF%9E%E7%BB%AD%E7%82%B9%E5%87%BB%E4%B8%80%E4%B8%AA%E6%8C%89%E9%92%AE%E8%A7%A6%E5%8F%91%E5%A4%9A%E6%AC%A1http%E8%AF%B7%E6%B1%82%E8%80%8C%E5%9B%B0%E6%89%B0%EF%BC%8C%E6%83%B3%E8%A6%81%E7%BB%9F%E4%B8%80%E5%A4%84%E7%90%86%E8%BF%99%E7%B1%BB%E9%97%AE%E9%A2%98"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#%E4%B8%80%E7%9B%B4%E8%A2%AB%E8%BF%9E%E7%BB%AD%E7%82%B9%E5%87%BB%E4%B8%80%E4%B8%AA%E6%8C%89%E9%92%AE%E8%A7%A6%E5%8F%91%E5%A4%9A%E6%AC%A1http%E8%AF%B7%E6%B1%82%E8%80%8C%E5%9B%B0%E6%89%B0%EF%BC%8C%E6%83%B3%E8%A6%81%E7%BB%9F%E4%B8%80%E5%A4%84%E7%90%86%E8%BF%99%E7%B1%BB%E9%97%AE%E9%A2%98"}}),s._v(" 一直被连续点击一个按钮触发多次Http请求而困扰，想要统一处理这类问题")]),a("h4",{attrs:{id:"%E9%80%9A%E8%BF%87-new-axios.canceltoken()-%E6%9D%A5%E6%B3%A8%E9%94%80%E9%87%8D%E5%A4%8D%E8%AF%B7%E6%B1%82"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#%E9%80%9A%E8%BF%87-new-axios.canceltoken()-%E6%9D%A5%E6%B3%A8%E9%94%80%E9%87%8D%E5%A4%8D%E8%AF%B7%E6%B1%82"}}),s._v(" 通过 new axios.CancelToken() 来注销重复请求")]),a("h3",{attrs:{id:"%E6%80%9D%E8%B7%AF"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#%E6%80%9D%E8%B7%AF"}}),s._v(" 思路")]),a("pre",{staticClass:"hljs"},[a("code",[s._v("1. 在axios拦截器中拦截发出的每条http请求并缓存起来， 判断是否重复\n2. 在axios拦截器中拦截响应后的http请求，清除缓存，保证发出的请求不会去缓存数据重复\n3. 【重点※】 如果是重复请求http请求， 未响应时又发出一条相同http， 在 1. 会走重复逻辑， 将重复的http请求清除\n")])]),a("h3",{attrs:{id:"%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BB%A3%E7%A0%81"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BB%A3%E7%A0%81"}}),s._v(" 直接上代码")]),a("pre",{staticClass:"hljs"},[a("code",[a("span",{staticClass:"hljs-comment"},[s._v("/**\n * axios全局配置，包括验证校验及错误处理\n */")]),s._v("\n"),a("span",{staticClass:"hljs-keyword"},[s._v("import")]),s._v(" axios "),a("span",{staticClass:"hljs-keyword"},[s._v("from")]),s._v(" "),a("span",{staticClass:"hljs-string"},[s._v("'axios'")]),s._v(";\n"),a("span",{staticClass:"hljs-keyword"},[s._v("import")]),s._v(" store "),a("span",{staticClass:"hljs-keyword"},[s._v("from")]),s._v(" "),a("span",{staticClass:"hljs-string"},[s._v("'../store'")]),s._v(";\n"),a("span",{staticClass:"hljs-keyword"},[s._v("import")]),s._v(" router "),a("span",{staticClass:"hljs-keyword"},[s._v("from")]),s._v(" "),a("span",{staticClass:"hljs-string"},[s._v("'../router'")]),s._v(";\n"),a("span",{staticClass:"hljs-comment"},[s._v("// import Cookies from 'js-cookie';")]),s._v("\n\n"),a("span",{staticClass:"hljs-comment"},[s._v("// 创建axios实例")]),s._v("\n"),a("span",{staticClass:"hljs-keyword"},[s._v("const")]),s._v(" service = axios.create({\n    "),a("span",{staticClass:"hljs-attr"},[s._v("withCredentials")]),s._v(": "),a("span",{staticClass:"hljs-literal"},[s._v("true")]),s._v(", "),a("span",{staticClass:"hljs-comment"},[s._v("// 允许跨域携带cookie")]),s._v("\n    "),a("span",{staticClass:"hljs-attr"},[s._v("timeout")]),s._v(": "),a("span",{staticClass:"hljs-number"},[s._v("1000")]),s._v(" * "),a("span",{staticClass:"hljs-number"},[s._v("30")]),s._v(" "),a("span",{staticClass:"hljs-comment"},[s._v("// 请求超时时间30秒")]),s._v("\n});\n"),a("span",{staticClass:"hljs-keyword"},[s._v("const")]),s._v(" pending = {}; "),a("span",{staticClass:"hljs-comment"},[s._v("// 缓存http请求")]),s._v("\n"),a("span",{staticClass:"hljs-keyword"},[s._v("const")]),s._v(" CancelToken = axios.CancelToken; "),a("span",{staticClass:"hljs-comment"},[s._v("// 取消请求的实例")]),s._v("\n"),a("span",{staticClass:"hljs-comment"},[s._v("// 清除重复请求、缓存")]),s._v("\n"),a("span",{staticClass:"hljs-keyword"},[s._v("const")]),s._v(" removePending = "),a("span",{staticClass:"hljs-function"},[s._v("("),a("span",{staticClass:"hljs-params"},[s._v("key, isRequest = "),a("span",{staticClass:"hljs-literal"},[s._v("false")])]),s._v(") =>")]),s._v(" {\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (pending[key] && isRequest) {\n        pending[key]({ "),a("span",{staticClass:"hljs-attr"},[s._v("msg")]),s._v(": "),a("span",{staticClass:"hljs-string"},[s._v("'取消重复请求'")]),s._v(" });\n    }\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("delete")]),s._v(" pending[key];\n};\n"),a("span",{staticClass:"hljs-comment"},[s._v("// 处理http请求，返回统一格式")]),s._v("\n"),a("span",{staticClass:"hljs-keyword"},[s._v("const")]),s._v(" getRequestIdentify = "),a("span",{staticClass:"hljs-function"},[s._v("("),a("span",{staticClass:"hljs-params"},[s._v("config, isReuest = "),a("span",{staticClass:"hljs-literal"},[s._v("false")])]),s._v(") =>")]),s._v(" {\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("let")]),s._v(" url = config.url;\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (isReuest) {\n        url = config.baseURL + config.url.substring("),a("span",{staticClass:"hljs-number"},[s._v("1")]),s._v(", config.url.length);\n    }\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("return")]),s._v(" config.method === "),a("span",{staticClass:"hljs-string"},[s._v("'get'")]),s._v(" ? "),a("span",{staticClass:"hljs-built_in"},[s._v("encodeURIComponent")]),s._v("(url + "),a("span",{staticClass:"hljs-built_in"},[s._v("JSON")]),s._v(".stringify(config.params)) : "),a("span",{staticClass:"hljs-built_in"},[s._v("encodeURIComponent")]),s._v("(config.url + "),a("span",{staticClass:"hljs-built_in"},[s._v("JSON")]),s._v(".stringify(config.data));\n};\n"),a("span",{staticClass:"hljs-comment"},[s._v("// request 拦截器")]),s._v("\nservice.interceptors.request.use(\n    "),a("span",{staticClass:"hljs-function"},[a("span",{staticClass:"hljs-params"},[s._v("config")]),s._v(" =>")]),s._v(" {\n        "),a("span",{staticClass:"hljs-comment"},[s._v("// 每次请求都为http头增加Authorization字段，其内容为userCode")]),s._v("\n        "),a("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (store.state.user.userCode) {\n            config.headers.Authorization = "),a("span",{staticClass:"hljs-string"},[s._v("`"),a("span",{staticClass:"hljs-subst"},[s._v("${store.state.user.userCode}")]),s._v("`")]),s._v(";\n        }\n        "),a("span",{staticClass:"hljs-comment"},[s._v("// 拦截重复请求(即当前正在进行的相同请求)")]),s._v("\n        "),a("span",{staticClass:"hljs-keyword"},[s._v("let")]),s._v(" requestData = getRequestIdentify(config, "),a("span",{staticClass:"hljs-literal"},[s._v("true")]),s._v(");\n        removePending(requestData, "),a("span",{staticClass:"hljs-literal"},[s._v("true")]),s._v(");\n\n        config.cancelToken = "),a("span",{staticClass:"hljs-keyword"},[s._v("new")]),s._v(" CancelToken("),a("span",{staticClass:"hljs-function"},[s._v("("),a("span",{staticClass:"hljs-params"},[s._v("c")]),s._v(") =>")]),s._v(" {\n            pending[requestData] = c;\n        });\n        "),a("span",{staticClass:"hljs-keyword"},[s._v("return")]),s._v(" config;\n    },\n    err => {\n        "),a("span",{staticClass:"hljs-keyword"},[s._v("return")]),s._v(" "),a("span",{staticClass:"hljs-built_in"},[s._v("Promise")]),s._v(".reject(err);\n    });\n\n"),a("span",{staticClass:"hljs-comment"},[s._v("// response 拦截器")]),s._v("\nservice.interceptors.response.use(\n    "),a("span",{staticClass:"hljs-function"},[a("span",{staticClass:"hljs-params"},[s._v("response")]),s._v(" =>")]),s._v(" {\n        "),a("span",{staticClass:"hljs-comment"},[s._v("// 把已经完成的请求从 pending 中移除")]),s._v("\n        "),a("span",{staticClass:"hljs-keyword"},[s._v("let")]),s._v(" requestData = getRequestIdentify(response.config);\n        removePending(requestData);\n        "),a("span",{staticClass:"hljs-keyword"},[s._v("return")]),s._v(" response;\n    },\n    error => {\n        "),a("span",{staticClass:"hljs-comment"},[s._v("// 请求已发出，但服务器响应的状态码不在 2xx 范围内")]),s._v("\n        "),a("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (error.response) {\n            "),a("span",{staticClass:"hljs-keyword"},[s._v("switch")]),s._v(" (error.response.status) {\n            "),a("span",{staticClass:"hljs-keyword"},[s._v("case")]),s._v(" "),a("span",{staticClass:"hljs-number"},[s._v("401")]),s._v(":\n                "),a("span",{staticClass:"hljs-comment"},[s._v("// 没有权限")]),s._v("\n                store.dispatch("),a("span",{staticClass:"hljs-string"},[s._v("'user/logout'")]),s._v(").then("),a("span",{staticClass:"hljs-function"},[a("span",{staticClass:"hljs-params"},[s._v("()")]),s._v(" =>")]),s._v(" {\n                    router.push(store.state.UNAUTHORIZED);\n                });\n                "),a("span",{staticClass:"hljs-keyword"},[s._v("break")]),s._v(";\n            "),a("span",{staticClass:"hljs-keyword"},[s._v("case")]),s._v(" "),a("span",{staticClass:"hljs-number"},[s._v("403")]),s._v(":\n                "),a("span",{staticClass:"hljs-comment"},[s._v("// 访问被拒绝")]),s._v("\n                store.dispatch("),a("span",{staticClass:"hljs-string"},[s._v("'user/logout'")]),s._v(").then("),a("span",{staticClass:"hljs-function"},[a("span",{staticClass:"hljs-params"},[s._v("()")]),s._v(" =>")]),s._v(" {\n                    store.dispatch("),a("span",{staticClass:"hljs-string"},[s._v("'user/tokenValidate'")]),s._v(");\n                });\n            }\n        }\n        "),a("span",{staticClass:"hljs-keyword"},[s._v("return")]),s._v(" "),a("span",{staticClass:"hljs-built_in"},[s._v("Promise")]),s._v(".reject(error.message);\n    }\n);\n\n"),a("span",{staticClass:"hljs-keyword"},[s._v("export")]),s._v(" "),a("span",{staticClass:"hljs-keyword"},[s._v("default")]),s._v(" service;\n\n")])])])}],l=a("2877"),i={},r=Object(l["a"])(i,n,e,!1,null,null,null);t["default"]=r.exports}}]);