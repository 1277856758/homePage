(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d21ad38"],{bcbc:function(s,t,a){"use strict";a.r(t);var n=function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"content"},[s._m(0),a("pre",{staticClass:"hljs"},[a("span",{staticClass:"hljs-lang",on:{click:s.ctrlC}},[a("em",[s._v("js")]),s._v("/复制代码")]),s._m(1)])])},l=[function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("h3",{attrs:{id:"webscoket"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#webscoket"}}),s._v(" webScoket")])},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("code",[a("span",{staticClass:"hljs-keyword"},[s._v("import")]),s._v(" store "),a("span",{staticClass:"hljs-keyword"},[s._v("from")]),s._v(" "),a("span",{staticClass:"hljs-string"},[s._v("'../store'")]),s._v(";\n"),a("span",{staticClass:"hljs-keyword"},[s._v("import")]),s._v(" Cookies "),a("span",{staticClass:"hljs-keyword"},[s._v("from")]),s._v(" "),a("span",{staticClass:"hljs-string"},[s._v("'js-cookie'")]),s._v(";\n\n"),a("span",{staticClass:"hljs-keyword"},[s._v("let")]),s._v(" socket = "),a("span",{staticClass:"hljs-literal"},[s._v("null")]),s._v(";\n"),a("span",{staticClass:"hljs-keyword"},[s._v("let")]),s._v(" timer = "),a("span",{staticClass:"hljs-literal"},[s._v("null")]),s._v(";\n"),a("span",{staticClass:"hljs-keyword"},[s._v("const")]),s._v(" time = "),a("span",{staticClass:"hljs-number"},[s._v("56000")]),s._v("; "),a("span",{staticClass:"hljs-comment"},[s._v("// nginx 默认60s,所以心跳时间需要 < 60000")]),s._v("\n"),a("span",{staticClass:"hljs-function"},[a("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" "),a("span",{staticClass:"hljs-title"},[s._v("init")]),s._v(" ("),a("span",{staticClass:"hljs-params"}),s._v(") ")]),s._v("{\n    "),a("span",{staticClass:"hljs-comment"},[s._v("// ReconnectingWebSocket 浏览器兼容以在插件中完成")]),s._v("\n    "),a("span",{staticClass:"hljs-comment"},[s._v("// if (!window.WebSocket) {")]),s._v("\n    "),a("span",{staticClass:"hljs-comment"},[s._v("//     alert('设备不支持WebSocket');")]),s._v("\n    "),a("span",{staticClass:"hljs-comment"},[s._v("//     return false;")]),s._v("\n    "),a("span",{staticClass:"hljs-comment"},[s._v("// }")]),s._v("\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (socket != "),a("span",{staticClass:"hljs-literal"},[s._v("null")]),s._v(" && socket.readyState === ReconnectingWebSocket.OPEN) {\n        "),a("span",{staticClass:"hljs-keyword"},[s._v("return")]),s._v(" "),a("span",{staticClass:"hljs-literal"},[s._v("false")]),s._v(";\n    }\n\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("let")]),s._v(" addr = process.env.NODE_ENV === "),a("span",{staticClass:"hljs-string"},[s._v("'development'")]),s._v(" ? "),a("span",{staticClass:"hljs-built_in"},[s._v("window")]),s._v(".staticRoute.development : "),a("span",{staticClass:"hljs-built_in"},[s._v("window")]),s._v(".staticRoute.production;\n    "),a("span",{staticClass:"hljs-comment"},[s._v("// let addr = process.env.NODE_ENV === 'development' ? window.staticRoute.development")]),s._v("\n    "),a("span",{staticClass:"hljs-comment"},[s._v("//     : process.env.VUE_APP_TITLE === 'test' ? window.staticRoute.test")]),s._v("\n    "),a("span",{staticClass:"hljs-comment"},[s._v("//         : window.staticRoute.production;")]),s._v("\n    socket = "),a("span",{staticClass:"hljs-keyword"},[s._v("new")]),s._v(" ReconnectingWebSocket(addr);\n\n    socket.onopen = wsopen;\n    socket.onclose = wsclose;\n    socket.onerror = wserror;\n    socket.onmessage = wsmessage;\n}\n\n"),a("span",{staticClass:"hljs-function"},[a("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" "),a("span",{staticClass:"hljs-title"},[s._v("ChatMsg")]),s._v(" ("),a("span",{staticClass:"hljs-params"},[s._v("userCode")]),s._v(") ")]),s._v("{\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".senderId = userCode;\n}\n\n"),a("span",{staticClass:"hljs-function"},[a("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" "),a("span",{staticClass:"hljs-title"},[s._v("DataContent")]),s._v(" ("),a("span",{staticClass:"hljs-params"},[s._v("type, chatMsg")]),s._v(") ")]),s._v("{\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".type = type;\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("this")]),s._v(".data = chatMsg;\n}\n\n"),a("span",{staticClass:"hljs-function"},[a("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" "),a("span",{staticClass:"hljs-title"},[s._v("keep_alive")]),s._v(" ("),a("span",{staticClass:"hljs-params"}),s._v(") ")]),s._v("{\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("const")]),s._v(" dataContent = "),a("span",{staticClass:"hljs-keyword"},[s._v("new")]),s._v(" DataContent("),a("span",{staticClass:"hljs-number"},[s._v("0")]),s._v(", "),a("span",{staticClass:"hljs-literal"},[s._v("null")]),s._v(");\n    chat("),a("span",{staticClass:"hljs-built_in"},[s._v("JSON")]),s._v(".stringify(dataContent));\n}\n\n"),a("span",{staticClass:"hljs-function"},[a("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" "),a("span",{staticClass:"hljs-title"},[s._v("chat")]),s._v(" ("),a("span",{staticClass:"hljs-params"},[s._v("msg")]),s._v(") ")]),s._v("{\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (socket != "),a("span",{staticClass:"hljs-literal"},[s._v("null")]),s._v(" && socket.readyState === WebSocket.OPEN) {\n        "),a("span",{staticClass:"hljs-comment"},[s._v("// console.log('发送消息：' + msg);")]),s._v("\n        socket.send(msg);\n    } "),a("span",{staticClass:"hljs-keyword"},[s._v("else")]),s._v(" {\n        init();\n        "),a("span",{staticClass:"hljs-comment"},[s._v("// eslint-disable-next-line")]),s._v("\n        setTimeout("),a("span",{staticClass:"hljs-string"},[s._v('"chat(\'"')]),s._v("+msg+"),a("span",{staticClass:"hljs-string"},[s._v('"\')"')]),s._v(", "),a("span",{staticClass:"hljs-number"},[s._v("3000")]),s._v(");\n    }\n}\n\n"),a("span",{staticClass:"hljs-function"},[a("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" "),a("span",{staticClass:"hljs-title"},[s._v("wsopen")]),s._v(" ("),a("span",{staticClass:"hljs-params"}),s._v(") ")]),s._v("{\n    "),a("span",{staticClass:"hljs-comment"},[s._v("// console.log('WebSocket已建立连接...');")]),s._v("\n    "),a("span",{staticClass:"hljs-comment"},[s._v("// 构建ChatMsg")]),s._v("\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("let")]),s._v(" chatMsg = "),a("span",{staticClass:"hljs-keyword"},[s._v("new")]),s._v(" ChatMsg(Cookies.get("),a("span",{staticClass:"hljs-string"},[s._v("'userNum'")]),s._v("));\n    "),a("span",{staticClass:"hljs-comment"},[s._v("// 构建DataContent")]),s._v("\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("let")]),s._v(" dataContent = "),a("span",{staticClass:"hljs-keyword"},[s._v("new")]),s._v(" DataContent("),a("span",{staticClass:"hljs-number"},[s._v("1")]),s._v(", chatMsg);\n    chat("),a("span",{staticClass:"hljs-built_in"},[s._v("JSON")]),s._v(".stringify(dataContent));\n    clearInterval(timer);\n    "),a("span",{staticClass:"hljs-comment"},[s._v("// webSocket心跳")]),s._v("\n    timer = setInterval(keep_alive, time);\n}\n\n"),a("span",{staticClass:"hljs-function"},[a("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" "),a("span",{staticClass:"hljs-title"},[s._v("wsclose")]),s._v(" ("),a("span",{staticClass:"hljs-params"}),s._v(") ")]),s._v("{\n    "),a("span",{staticClass:"hljs-comment"},[s._v("// console.log('连接关闭...');")]),s._v("\n    clearInterval(timer);\n}\n\n"),a("span",{staticClass:"hljs-function"},[a("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" "),a("span",{staticClass:"hljs-title"},[s._v("wserror")]),s._v(" ("),a("span",{staticClass:"hljs-params"}),s._v(") ")]),s._v("{\n    "),a("span",{staticClass:"hljs-comment"},[s._v("// console.log('发生错误...');")]),s._v("\n    clearInterval(timer);\n}\n\n"),a("span",{staticClass:"hljs-function"},[a("span",{staticClass:"hljs-keyword"},[s._v("function")]),s._v(" "),a("span",{staticClass:"hljs-title"},[s._v("wsmessage")]),s._v(" ("),a("span",{staticClass:"hljs-params"},[s._v("event")]),s._v(") ")]),s._v("{\n    "),a("span",{staticClass:"hljs-comment"},[s._v("// console.log('响应消息');")]),s._v("\n    "),a("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (event.data != "),a("span",{staticClass:"hljs-literal"},[s._v("null")]),s._v(") {\n        "),a("span",{staticClass:"hljs-keyword"},[s._v("let")]),s._v(" json = "),a("span",{staticClass:"hljs-built_in"},[s._v("JSON")]),s._v(".parse(event.data);\n        "),a("span",{staticClass:"hljs-comment"},[s._v("// console.log(json);")]),s._v("\n        "),a("span",{staticClass:"hljs-comment"},[s._v("// 刷新文件解析进度")]),s._v("\n        "),a("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (json.type === "),a("span",{staticClass:"hljs-number"},[s._v("2")]),s._v(") {\n            store.commit("),a("span",{staticClass:"hljs-string"},[s._v("'updateTableUpload'")]),s._v(", json.data.msg);\n        }\n        "),a("span",{staticClass:"hljs-comment"},[s._v("// 刷新正在解析个数")]),s._v("\n        "),a("span",{staticClass:"hljs-keyword"},[s._v("if")]),s._v(" (json.type === "),a("span",{staticClass:"hljs-number"},[s._v("4")]),s._v(") {\n            store.commit("),a("span",{staticClass:"hljs-string"},[s._v("'setWebsocketLen'")]),s._v(", json.data.msg.total);\n        }\n    }\n}\n\n"),a("span",{staticClass:"hljs-keyword"},[s._v("export")]),s._v(" "),a("span",{staticClass:"hljs-keyword"},[s._v("default")]),s._v(" init;\n\n")])}],e=a("2877"),c={},i=Object(e["a"])(c,n,l,!1,null,null,null);t["default"]=i.exports}}]);